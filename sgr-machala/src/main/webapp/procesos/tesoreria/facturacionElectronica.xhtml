<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                template="/template/bpmTemplate.xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui">
    <ui:define name="title">Facturas Electrónicas</ui:define>
    <ui:define name="content">
        <h:form id="mainForm">
            <center><h2>FACTURACIÓN ELECTRÓNICA</h2></center>
            <p:tabView id="tabFacturacion">
                <p:tab title="Comprobacion de Autorizacion">
                    <h:panelGrid styleClass="noBorder" columns="1">
                        <p:outputLabel value="Nota: NO INTENTAR REENVIAR FACTURAS EN ESTADO NO AUTORIZADO o DEVUELTA, PRIMERO SE DEBEN CORREGIR LOS DATOS DEL COMPROBANTE." style="font-weight: bolder; font-size: 14px;"/>
                    </h:panelGrid> <br></br>
                    <h:panelGrid  columns="7" style="font-weight: bolder">
                        <h:panelGroup>
                            Estado: <br/> 
                            <p:selectOneMenu value="#{facturacionElectronica.estado}">
                                <f:selectItem itemLabel="TODOS" itemValue="#{1}"/>
                                <f:selectItem itemLabel="NO AUTORIZADOS" itemValue="#{2}"/>
                            </p:selectOneMenu>
                        </h:panelGroup>
                        <h:panelGroup>
                            <p:spacer width="15" />
                        </h:panelGroup>
                        <h:panelGroup>
                            Usuario: <br/>
                            <p:selectOneMenu value="#{facturacionElectronica.caja}" converter="entityConverter">
                                <f:selectItem itemLabel="TODOS" itemValue="#{null}"/>
                                <f:selectItems value="#{facturacionElectronica.cajeros}" var="caj" itemLabel="#{caj.usuario}" itemValue="#{caj}"/>
                            </p:selectOneMenu>
                        </h:panelGroup>
                        <h:panelGroup>                            
                            <p:spacer width="15" />
                        </h:panelGroup>
                        <h:panelGroup>
                            Fecha de Ingreso: <br/>
                            <p:calendar value="#{facturacionElectronica.ingreso}" maxdate="sysdate" pattern="dd/MM/yyyy" />
                        </h:panelGroup>
                        <h:panelGroup>
                            <p:spacer width="5" />
                        </h:panelGroup>
                        <h:panelGroup>
                            <p:outputLabel value=""/> <br></br>
                            <p:commandButton value="Consulta Proformas" icon="pi pi-search" 
                                             actionListener="#{facturacionElectronica.consultarFacturasElectronicas()}"/>    
                        </h:panelGroup>

                    </h:panelGrid>
                    <br></br>
                    <p:dataTable value="#{facturacionElectronica.facturas}" var="fac" filterEvent="enter"
                                 scrollable="true" scrollHeight="400" rowIndexVar="index" id="dtFacturas">
                        <p:column headerText="**" width="30">
                            #{index + 1}
                        </p:column>
                        <p:column headerText="Nro.Tramite" width="60" filterBy="#{fac.numTramiteRp}">
                            #{fac.numTramiteRp}
                        </p:column>
                        <p:column headerText="Id Factura" width="60">
                            #{fac.tituloCredito}
                        </p:column>
                        <p:column headerText="Estado" >
                            #{fac.estadoWs}
                        </p:column>
                        <p:column headerText="Comprobante" >
                            #{fac.codigoComprobante}
                        </p:column>
                        <p:column headerText="Clave de Acceso" width="360" >
                            #{fac.claveAcceso}
                        </p:column> 
                        <p:column headerText="Cliente" >
                            #{fac.beneficiario.nombreCompleto}
                        </p:column>
                        <p:column headerText="Valor Total" width="65">
                            #{fac.totalPagar}
                        </p:column>
                        <p:column headerText="JSON" width="25">
                            <p:commandLink actionListener="#{facturacionElectronica.visualizarJson(fac)}" 
                                           title="Enviar Factura" update="mainForm:tabFacturacion:dtFacturas">
                                <p:graphicImage value="/resources/icons/abrir.png" height="22"/>   
                            </p:commandLink>
                        </p:column>
                        <p:column headerText="Generar Factura" width="25">
                            <p:commandLink actionListener="#{facturacionElectronica.enviarFactura(fac)}" 
                                           title="Enviar Factura al SRI" update="mainForm:tabFacturacion:dtFacturas">
                                <p:graphicImage value="/resources/icons/ir.png" height="22"/>   
                            </p:commandLink>
                        </p:column>
                        <p:column headerText="Emitir SRI" width="25">
                            <p:commandLink actionListener="#{facturacionElectronica.autorizarFactura(fac)}" 
                                           title="Autorizar Factura en SRI" update="mainForm:tabFacturacion:dtFacturas">
                                <p:graphicImage value="/resources/icons/check.png" height="22"/>   
                            </p:commandLink>
                        </p:column>
                        <p:column headerText="Consultar Estado" width="25">
                            <p:commandLink actionListener="#{facturacionElectronica.consultarEstadoFactura(fac)}" 
                                           title="Autorizar Factura en SRI" update="mainForm:tabFacturacion:dtFacturas">
                                <p:graphicImage value="/resources/icons/buscar.png" height="22"/>   
                            </p:commandLink>
                        </p:column>
                    </p:dataTable>
                </p:tab>
                <p:tab title="Alcance de Pagos Autorización" >
                    <p:dataTable id="dtEmisiones" paginator="true" lazy="true" rows="20" rowsPerPageTemplate="20,50,100" style="text-align: center;font-size: 10px;"
                                 paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {CurrentPageReport} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                 value="#{facturacionElectronica.emisiones}" var="em" filterEvent="enter">
                        <p:column headerText="Tramite"  filterBy="#{em.numTramite}" width="80">
                            <h:outputText value="#{em.numTramite}"></h:outputText>
                        </p:column>
                        <p:column headerText="No Factura" filterBy="#{em.codigoComprobante}" width="120" filterStyle="width: 95%" rendered="false">
                            <h:outputText value="#{em.codigoComprobante}"/>
                        </p:column>

                        <p:column headerText="F.Emision" width="50">
                            <h:outputText value="#{em.fecha}"><f:convertDateTime pattern="dd/MM/yyyy"/></h:outputText>
                        </p:column>
                        <p:column headerText="Total $" width="80">
                            <p:outputLabel value="#{em.totalPagar}"><f:convertNumber minFractionDigits="2"/></p:outputLabel>
                        </p:column>

                        <p:column headerText="No Autorizacion" width="100" >
                            <h:outputText  value="#{em.numeroAutorizacion}"/>
                        </p:column>
                        <p:column headerText="CI/RUC" width="100">
                            <h:outputText value="#{em.solicitante.ciRuc}"/>
                        </p:column>
                        <p:column headerText="Cliente" >
                            <h:outputText value="#{em.solicitante.nombreCompleto}"/>
                        </p:column>
                        <p:column headerText="Estado" width="50" rendered="false">
                            <h:outputText value="#{em.estadoWs}"/>
                        </p:column>
                        <p:column headerText="Observacion" width="300">
                            <h:outputText value="#{em.observacion}"/>
                        </p:column>
                        <p:column headerText="PDF" width="20">
                            <!--<p:commandLink actionListener="# {facturacionElectronica.downloadFactura(em)}" title="# {em.codigoComprobante}">-->
                            <p:commandButton icon="pi pi-print" actionListener="#{facturacionElectronica.generarComprobante(em.id, em.totalPagar)}" 
                                     title="Comprobante de Ingreso" style="background-color: darkgoldenrod;" />
                        </p:column>
                        <p:column headerText="***" width="20">
                            <p:commandButton icon="pi pi-envelope" actionListener="#{facturacionElectronica.showEnvComprobante(em)}" 
                                     title="Reenviar Comprobante"/>
                            <!-- comment 
                            <p:commandLink actionListener="#{facturacionElectronica.reenvioEmision(em)}" update="dtEmisiones" title="#{em.codigoComprobante}">
                                <p:graphicImage value="/resources/icons/refres.png" height="16"/>   
                            </p:commandLink>
                            -->
                        </p:column>
                    </p:dataTable>
                </p:tab>
                <p:tab title="Notas de Crédito">
                    <p:dataTable paginator="true" lazy="true" rows="20" rowsPerPageTemplate="20,50,100" style="text-align: center;"
                                 paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {CurrentPageReport} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                 value="#{notasCredito.lazy}" var="nc" filterEvent="enter">
                        <p:column headerText="No Tramite" filterBy="#{nc.factura.numTramiteRp}" width="100" filterStyle="width: 95%">
                            <h:outputText  value="#{nc.factura.numTramiteRp}"/>
                        </p:column>
                        <p:column headerText="No Factura Sustento" filterBy="#{nc.factura.codigoComprobante}" width="140" filterStyle="width: 95%">
                            <h:outputText  value="#{nc.factura.codigoComprobante}"/>
                        </p:column>
                        <p:column headerText="F.Emision Sustento" width="100">
                            <h:outputText value="#{nc.factura.fechaIngreso}"><f:convertDateTime pattern="dd/MM/yyyy"/></h:outputText>
                        </p:column>
                        <p:column headerText="Valor Total $" width="100">
                            <p:outputLabel value="#{nc.valorTotal}"><f:convertNumber minFractionDigits="2"/></p:outputLabel>
                        </p:column>
                        <p:column headerText="Estado" width="100">
                            <h:outputText value="#{nc.estado}"/>
                        </p:column>
                        <p:column headerText="No Documento" filterBy="#{nc.numeroDocumento}" width="140" filterStyle="width: 95%">
                            <h:outputText  value="#{nc.numeroDocumento}"/>
                        </p:column>
                        <p:column headerText="No Autorizacion" filterBy="#{nc.numeroAutorizacion}" width="140" filterStyle="width: 95%">
                            <h:outputText  value="#{nc.numeroAutorizacion}"/>
                        </p:column>
                        <p:column headerText="F.Emision" width="100">
                            <h:outputText value="#{nc.fechaEmision}"><f:convertDateTime pattern="dd/MM/yyyy"/></h:outputText>
                        </p:column>
                        <p:column headerText="PDF" width="40" rendered="false">
                            <p:commandLink actionListener="#{facturacionElectronica.downloadNotaCredito(nc)}">
                                <p:graphicImage value="/resources/icons/reporte.png" height="16"/>   
                            </p:commandLink>
                        </p:column>
                        <p:column headerText="***" width="30">
                            <p:commandLink actionListener="#{facturacionElectronica.reenvioNotaCredito(nc)}" title="#{nc.numeroDocumento}">
                                <p:graphicImage value="/resources/icons/refres.png" height="16"/>   
                            </p:commandLink>
                        </p:column>
                    </p:dataTable>
                </p:tab>
                <p:tab title="Facturas de Solicitante" rendered="false" >
                    <h:panelGrid id="pnlSolicitante" style="font-weight: bold" columns="5">

                        <h:panelGroup style="block">
                            <p:outputLabel value="CI/RUC:" /> <br></br>
                            <p:inputText value="#{facturacionElectronica.solicitante.ciRuc}" readonly="true"/>    
                        </h:panelGroup>
                        <h:panelGroup style="block">
                            <p:outputLabel value="Nombre:" /> <br></br>
                            <p:inputText value="#{facturacionElectronica.solicitante.nombreCompleto}" size="50" readonly="true"/>
                        </h:panelGroup>
                        <h:panelGroup style="block">
                            <p:outputLabel value="" /> <br></br>
                            <p:commandButton value="Buscar Solicitante" 
                                             icon="ui-icon-person" 
                                             styleClass="btnStyle" 
                                             actionListener="#{facturacionElectronica.showDlg('/resources/dialog/dlglazyente')}"
                                             >
                                <p:ajax event="dialogReturn" 
                                        listener="#{facturacionElectronica.selectObject}" 
                                        update="mainForm:tabFacturacion:pnlSolicitante, dtActos"/>
                            </p:commandButton>    
                        </h:panelGroup>

                        <!--                        <h:panelGroup style="block">
                                                    <p:outputLabel value="" /> <br></br>
                                                    <p:commandButton value="Consultar Facturas" 
                                                                     styleClass="btnStyle" 
                                                                     icon="ui-icon-document" 
                                                                     actionListener="# {facturacionElectronica.consultarComprobantes()}"
                                                                     update="dtActos"/>
                                                </h:panelGroup>-->

                    </h:panelGrid>
                    <!--                    <h:panelGrid columns="5" style="font-weight: bold" >
                                            <h:panelGroup style="block">
                                                <p:outputLabel value="Desde:" /> <br></br>
                                                <p:calendar value="# {facturacionElectronica.desde}" pattern="dd/MM/yyyy"/>
                                            </h:panelGroup>
                                            <h:panelGroup style="block">
                                                <p:outputLabel value="Hasta:" /> <br></br>
                                                <p:calendar value="# {facturacionElectronica.hasta}" pattern="dd/MM/yyyy"/>
                                            </h:panelGroup>
                                            
                    
                                        </h:panelGrid>-->
                    <br></br>
                    <p:dataTable id="dtActos" var="comprobante" 
                                 value="#{facturacionElectronica.comprobantesElectronicos}"   
                                 rowIndexVar="index"
                                 filterEvent="enter"
                                 style="text-align: center; margin: 0 auto;" emptyMessage="Sin elementos..." 
                                 scrollable="true" scrollHeight="550">
                        <f:facet name="header">Comprobantes Electrónicos</f:facet>
                        <p:column headerText="**" width="35">
                            #{index + 1}
                        </p:column>
                        <p:column headerText="Tipo de Comprobante" width="10%">
                            <p:outputLabel value="#{comprobante.tipoComprobante}"/>
                        </p:column>
                        <p:column headerText="Número de Autorización" >
                            <p:outputLabel value="#{comprobante.numAutorizacion}"/>
                        </p:column>
                        <p:column headerText="Clave de Acceso">
                            <p:outputLabel value="#{comprobante.claveAcceso}"/>
                        </p:column>
                        <p:column headerText="Número de Comprobante" filterMatchMode="contains" filterBy="#{comprobante.numFacturaFormato}">
                            <p:outputLabel value="#{comprobante.numFacturaFormato}"/>
                        </p:column>
                        <p:column headerText="Fecha de Autorización" width="10%">
                            <p:outputLabel value="#{comprobante.fechaAutorizacion}"/>
                        </p:column>  
                        <p:column headerText="Valor Total" width="10%">
                            <p:outputLabel value="#{comprobante.valorTotal}"/>
                        </p:column>
                        <p:column headerText="RIDE" width="10%">
                            <p:commandLink actionListener="#{facturacionElectronica.generarReporteFacturacionElectronica(comprobante.pdfPath)}" ajax="false">
                                <p:graphicImage value="/resources/icons/reporte.png" height="16"/>   
                            </p:commandLink>
                        </p:column>  
                        <p:column headerText="XML" width="10%">
                            <p:commandLink actionListener="#{facturacionElectronica.xmlComprobanteSRI(comprobante.xmlPath)}"  >
                                <p:graphicImage value="/resources/icons/xml.jpg" height="16"/>   
                            </p:commandLink>
                        </p:column>  
                        <p:column headerText="Reenviar Correo" width="40">
                            <p:commandLink actionListener="#{facturacionElectronica.cargarCorreoFacturaElectronicaSRI(comprobante)}" >
                                <p:graphicImage value="/resources/icons/enviar.png" height="16"/>   
                            </p:commandLink>
                        </p:column>
                    </p:dataTable>
                </p:tab>

                <p:tab title="Facturas Anteriores" rendered="false">
                    <p:panelGrid id="pnlComandos" styleClass="noBorder" columns="7">
                        Usuario:
                        <p:selectOneMenu value="#{facturacionElectronica.user}" converter="entityConverter" disabled="#{facturacionElectronica.block}">
                            <f:selectItem itemLabel="Seleccionar" itemValue="#{null}"/>
                            <f:selectItems value="#{facturacionElectronica.cajeros}" var="caj" itemLabel="#{caj.usuario}" itemValue="#{caj}"/>
                        </p:selectOneMenu>
                        Fecha de Ingreso:
                        <p:calendar value="#{facturacionElectronica.fecha}" maxdate="sysdate" pattern="dd/MM/yyyy" disabled="#{facturacionElectronica.block}"/>
                        <p:commandButton value="Cargar Facturas Autorizadas" styleClass="btnStyle" icon="ui-icon-refresh" disabled="#{facturacionElectronica.block}"
                                         actionListener="#{facturacionElectronica.cargarFacturasAutorizadas()}"/>
                        <p:commandButton value="Generar RIDE" styleClass="btnStyle" icon="ui-icon-document" disabled="#{facturacionElectronica.block}"
                                         actionListener="#{facturacionElectronica.generarRIDE()}"/>
                        <p:commandButton value="Enviar Emails" styleClass="btnStyle" icon="ui-icon-check" disabled="#{facturacionElectronica.block}"
                                         actionListener="#{facturacionElectronica.enviarTodosLosCorreos()}"/>
                    </p:panelGrid>
                    <p:dataTable value="#{facturacionElectronica.liquidaciones}" var="liq" style="text-align: center;"
                                 scrollable="true" scrollHeight="400" rowIndexVar="index">
                        <p:column headerText="**" width="35">
                            #{index + 1}
                        </p:column>
                        <p:column headerText="Tramite" width="75">
                            #{liq.numTramiteRp}
                        </p:column>
                        <p:column headerText="Factura" width="70">
                            #{liq.numeroComprobante}
                        </p:column>
                        <p:column headerText="CI/RUC" width="100" rendered="false">
                            #{liq.solicitante.ciRuc}
                        </p:column>
                        <p:column headerText="Nombres">
                            #{liq.solicitante.nombreCompleto}
                        </p:column>
                        <p:column headerText="No de Autorizacion" width="400">
                            #{liq.numeroAutorizacion}
                        </p:column>
                        <p:column headerText="Fecha Auto." width="140">
                            <h:outputText value="#{liq.fechaAutorizacion}">
                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Sub-Total" width="100" rendered="false">
                            #{liq.subTotal}
                        </p:column>
                        <p:column headerText="Desc.Ley" width="100" rendered="false">
                            #{liq.descuentoValor}
                        </p:column>
                        <p:column headerText="Desc.Limit." width="100" rendered="false">
                            #{liq.descLimitCobro}
                        </p:column>
                        <p:column headerText="Total" width="75">
                            #{liq.totalPagar}
                        </p:column>
                        <p:column headerText="Mail" width="40">
                            <p:commandLink actionListener="#{facturacionElectronica.enviarNotificacion(liq)}" title="#{liq.numTramiteRp}">
                                <p:graphicImage value="/resources/icons/email.png" height="16"/>   
                            </p:commandLink>
                        </p:column>
                    </p:dataTable>
                </p:tab>
            </p:tabView>
        </h:form>

        <p:dialog id="dlgReenvioCorreo" widgetVar="dlgReenvioCorreo" header="Reenviar RIDE Correo" modal="true" width="400" 
                  resizable="false" position="center">
            <h:form id="formCorreo">
                <center>
                    <p:outputLabel value="#{facturacionElectronica.comprobanteSRI.numFacturaFormato}" style="font-weight: bolder;font-size: 16px; color: green"/>
                </center>
                <br></br>
                <p:outputLabel value="Correo Electrónico" style="font-weight: bolder;font-size: 16px"/>
                <p:inputText value="#{facturacionElectronica.comprobanteSRI.contribuyente.email}" 
                             style="width: 100%" />
                <br/><br/>
                <center>
                    <p:commandButton value="Aceptar" styleClass="btnStyle" icon="ui-icon-check"
                                     actionListener="#{facturacionElectronica.reenviarCorreoFacturaElectronicaSRI()}"/>
                </center>
            </h:form>
        </p:dialog>
        
        <p:dialog widgetVar="dlgVerJson" header="Respuesta" modal="true" width="700" resizable="false" position="top">
            <h:form id="formVerJson">
                <p:inputTextarea readonly="true" value="#{facturacionElectronica.jsonRespuesta}" style="width: 100%"
                                 autoResize="false" rows="40" />
            </h:form>
        </p:dialog>
        
        <p:dialog widgetVar="dlgReenvioComp" header="Reenviar Comprobante" modal="true" width="600" 
                  resizable="false" position="center">
            <h:form id="formEnvioCompMail">
                <h:panelGroup>
                    <p:outputLabel value="Nro. Trámite:" style="font-weight: bold; font-size: 18px;color: #00a9e7"/>
                    <p:spacer width="20" height="1"/>
                    <p:outputLabel value="#{facturacionElectronica.liquidacion.numTramiteRp}" style="font-weight: bold; font-size: 18px;"/><br/>
                    <p:outputLabel value="Factura:" style="font-weight: bold; font-size: 18px;color: #00a9e7"/>
                    <p:spacer width="20" height="1"/>
                    <p:outputLabel value="#{facturacionElectronica.nombresFact}" style="font-weight: bold; font-size: 18px;"/>    
                </h:panelGroup>
                <h:panelGrid columns="1" style="width: 100%;text-align: center;">
                    <p:outputLabel value="Confirmar Correo:" style="font-weight: bolder;font-size: 16px"/>
                    <p:inputText value="#{facturacionElectronica.liquidacion.correoTramite}" style="width: 100%" maxlength="99"/>
                    <p:spacer width="1"/>
                    <p:commandButton value="Reenviar" icon="pi pi-send" actionListener="#{facturacionElectronica.continuarEnvCorreo()}" />
                </h:panelGrid>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>