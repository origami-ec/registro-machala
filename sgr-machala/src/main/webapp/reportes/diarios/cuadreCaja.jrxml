<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="cuadreCaja" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="0" bottomMargin="0" uuid="44c41430-ab03-4fa9-995f-d6837b1f4bd8">
	<property name="ireport.zoom" value="1.5394743546921212"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="240"/>
	<style name="ANULADA" mode="Opaque" forecolor="#000000" backcolor="#FF9999"/>
	<style name="negrita" pdfFontName="Helvetica-Bold"/>
	<parameter name="DESDE" class="java.lang.String"/>
	<parameter name="HASTA" class="java.lang.String"/>
	<parameter name="HASTA_STRING" class="java.lang.String"/>
	<parameter name="USUARIO" class="java.lang.Long"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["C:\\Users\\Anyelo\\Desktop\\NetBeansProjects\\rpp\\src\\main\\webapp\\reportes\\diarios\\"]]></defaultValueExpression>
	</parameter>
	<parameter name="IMG_URL" class="java.lang.String"/>
	<parameter name="TESORERA" class="java.lang.String"/>
	<parameter name="COORDINADORA" class="java.lang.String"/>
	<parameter name="CONTADORA" class="java.lang.String"/>
	<queryString>
		<![CDATA[SELECT
    (
        SELECT initcap(coalesce(e.nombres, '') || ' ' || coalesce(e.apellidos, ''))
        FROM app.acl_user us
        LEFT JOIN app.cat_ente e ON e.id = us.ente
        WHERE us.id = $P{USUARIO}
    ) AS recaudador,
    COALESCE(SUM(ins_total), 0) AS ins_total,
    COALESCE(SUM(cert_total), 0) AS cert_total,
    COALESCE(SUM(total), 0) AS total_global_neto
FROM (
    SELECT
        p.id,
        CASE WHEN a.solvencia = false THEN p.valor ELSE 0 END AS ins_total,
        CASE WHEN a.solvencia = true THEN p.valor ELSE 0 END AS cert_total,
        p.valor AS total
    FROM financiero.ren_pago p
    LEFT JOIN flow.regp_liquidacion li ON li.id = p.liquidacion and li.fecha_ingreso::date = p.fecha_pago::date
    LEFT JOIN financiero.ren_pago_rubro r ON r.pago = p.id
    LEFT JOIN app.reg_acto a ON a.id = r.rubro
    WHERE li.estado_liquidacion = 2
      AND (
        CASE
            WHEN $P{USUARIO} > 0
                THEN li.user_ingreso = $P{USUARIO}
            ELSE
                li.user_ingreso > 0
        END
    )
      AND li.estado_pago = 2
      AND p.fecha_pago BETWEEN
          to_timestamp($P{DESDE}, 'DD/MM/YYYY HH24:MI')::timestamp
          AND to_timestamp($P{HASTA}, 'DD/MM/YYYY HH24:MI')::timestamp
    GROUP BY p.id, p.valor, a.solvencia
    UNION ALL
    SELECT
        fa.id,
        CASE WHEN act.solvencia = false THEN fa.total_pagar ELSE 0 END AS ins_total,
        CASE WHEN act.solvencia = true THEN fa.total_pagar ELSE 0 END AS cert_total,
        fa.total_pagar AS total
    FROM financiero.ren_factura fa
    LEFT JOIN financiero.ren_cajero ca ON ca.id = fa.caja
    LEFT JOIN app.acl_user us ON us.id = ca.usuario
    LEFT JOIN flow.regp_liquidacion li ON li.id = fa.liquidacion
    LEFT JOIN flow.regp_liquidacion_detalles ld
           ON ld.liquidacion = li.id
          AND ld.fecha_ingreso::date = fa.fecha::date
    LEFT JOIN app.reg_acto act ON act.id = ld.acto
    WHERE li.estado_liquidacion = 2
AND (
        CASE
            WHEN $P{USUARIO} > 0
                THEN ca.usuario = $P{USUARIO}
            ELSE
                ca.usuario > 0
        END
    )
      AND li.estado_pago = 2
      AND fa.fecha BETWEEN
          to_timestamp($P{DESDE}, 'DD/MM/YYYY HH24:MI')::timestamp
          AND to_timestamp($P{HASTA}, 'DD/MM/YYYY HH24:MI')::timestamp
    GROUP BY fa.id, fa.total_pagar, act.solvencia
) t;]]>
	</queryString>
	<field name="recaudador" class="java.lang.String"/>
	<field name="ins_total" class="java.math.BigDecimal"/>
	<field name="cert_total" class="java.math.BigDecimal"/>
	<field name="total_global_neto" class="java.math.BigDecimal"/>
	<background>
		<band height="842" splitType="Stretch">
			<image scaleImage="FillFrame" hAlign="Center" vAlign="Middle">
				<reportElement x="0" y="0" width="555" height="842" uuid="3f5a2fb4-5602-4d58-8afa-d6109889858f"/>
				<imageExpression><![CDATA[$P{IMG_URL}]]></imageExpression>
			</image>
		</band>
	</background>
	<pageHeader>
		<band height="50"/>
	</pageHeader>
	<columnHeader>
		<band height="114">
			<staticText>
				<reportElement style="negrita" x="4" y="45" width="551" height="22" uuid="20ce27e1-57a0-421a-97c7-54a3302db764"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="14" isBold="false"/>
				</textElement>
				<text><![CDATA[REPORTE DE RECAUDACIÓN]]></text>
			</staticText>
			<textField>
				<reportElement x="50" y="83" width="124" height="14" uuid="0eb3cd59-2287-4329-b7d2-1be1531868d8"/>
				<textFieldExpression><![CDATA[$P{HASTA_STRING}]]></textFieldExpression>
			</textField>
			<textField pattern="dd/MM/yyyy" isBlankWhenNull="true">
				<reportElement x="50" y="69" width="124" height="14" uuid="634c41f6-8a42-4bb1-8589-b8e1c9b82aee"/>
				<textFieldExpression><![CDATA[$P{DESDE}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="6" y="69" width="40" height="14" uuid="2535145b-8625-498c-9484-e429c12b69a4"/>
				<text><![CDATA[Desde:]]></text>
			</staticText>
			<staticText>
				<reportElement x="6" y="83" width="40" height="14" uuid="270e8d2c-d486-423c-8af1-ac64a9ad480b"/>
				<text><![CDATA[Hasta:]]></text>
			</staticText>
			<staticText>
				<reportElement x="200" y="83" width="46" height="14" uuid="bcfcde9b-058a-484f-b38d-770b52d7d32c"/>
				<text><![CDATA[Cajero:]]></text>
			</staticText>
			<textField isBlankWhenNull="true">
				<reportElement x="250" y="83" width="214" height="14" uuid="20c7e188-dbf2-462f-9463-e6491fbcfe33"/>
				<textFieldExpression><![CDATA[$P{USUARIO} == 0 ? "TODOS" : $F{recaudador}]]></textFieldExpression>
			</textField>
			<textField pattern="dd/MM/yyyy HH:mm:ss">
				<reportElement x="318" y="69" width="146" height="14" uuid="2fecf96a-a9ee-4a49-9154-dc4487b3f1b8"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="200" y="69" width="114" height="14" uuid="eeec1bbe-33b2-41a7-9e59-9bc5a94d8e0e"/>
				<text><![CDATA[Fecha de Impresión:]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="49" splitType="Stretch">
			<subreport runToBottom="false">
				<reportElement positionType="Float" x="10" y="0" width="521" height="24" isRemoveLineWhenBlank="true" uuid="12735d9f-f74b-4888-827f-0ac4050f2fa5"/>
				<subreportParameter name="HASTA">
					<subreportParameterExpression><![CDATA[$P{HASTA}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="USUARIO">
					<subreportParameterExpression><![CDATA[$P{USUARIO}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="DESDE">
					<subreportParameterExpression><![CDATA[$P{DESDE}]]></subreportParameterExpression>
				</subreportParameter>
				<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
				<subreportExpression><![CDATA[$P{SUBREPORT_DIR} + "cuadrecajaInscripciones.jasper"]]></subreportExpression>
			</subreport>
			<subreport runToBottom="false">
				<reportElement positionType="Float" x="10" y="24" width="521" height="25" isRemoveLineWhenBlank="true" isPrintWhenDetailOverflows="true" uuid="c0f58fc7-b028-4b9e-a4c9-f9f40ccca324"/>
				<subreportParameter name="HASTA">
					<subreportParameterExpression><![CDATA[$P{HASTA}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="USUARIO">
					<subreportParameterExpression><![CDATA[$P{USUARIO}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="DESDE">
					<subreportParameterExpression><![CDATA[$P{DESDE}]]></subreportParameterExpression>
				</subreportParameter>
				<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
				<subreportExpression><![CDATA[$P{SUBREPORT_DIR} + "cuadrecajaCertificaciones.jasper"]]></subreportExpression>
			</subreport>
		</band>
	</detail>
	<pageFooter>
		<band height="76" splitType="Prevent">
			<textField>
				<reportElement x="483" y="25" width="38" height="16" uuid="8103c524-5467-4837-a5b8-e89f98e75c07"/>
				<textElement verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA["Pág. "+$V{PAGE_NUMBER}+" de"]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report">
				<reportElement x="521" y="25" width="34" height="16" uuid="fdbeb83d-340b-48e5-a4e7-395ad488ce20"/>
				<textElement verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="112" y="27" width="118" height="14" uuid="941b0e7b-9a5f-4e52-8fac-94744c6515e5"/>
				<text><![CDATA[Fecha de Impresión:]]></text>
			</staticText>
			<textField pattern="dd/MM/yyyy HH:mm:ss">
				<reportElement x="230" y="27" width="150" height="14" uuid="00baf40a-8f5b-4d9b-8c01-1fedd64f2acb"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="200" splitType="Stretch">
			<textField isBlankWhenNull="true">
				<reportElement stretchType="RelativeToTallestObject" x="8" y="119" width="269" height="16" isPrintWhenDetailOverflows="true" uuid="435fd6bd-2541-4cd3-8988-dc95a1b58b28"/>
				<box leftPadding="2">
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font isBold="false"/>
				</textElement>
				<textFieldExpression><![CDATA["GENERADO POR"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="negrita" stretchType="RelativeToTallestObject" x="8" y="135" width="269" height="60" isPrintWhenDetailOverflows="true" uuid="5d782448-b489-402b-a7b0-bc719292d430"/>
				<box leftPadding="2">
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement verticalAlignment="Bottom"/>
				<textFieldExpression><![CDATA[$P{TESORERA}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement stretchType="RelativeToTallestObject" x="286" y="119" width="256" height="16" isPrintWhenDetailOverflows="true" uuid="01ca3a4a-7d89-4ac1-b200-33c99f343d77"/>
				<box leftPadding="2">
					<topPen lineWidth="1.0"/>
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font isBold="false"/>
				</textElement>
				<textFieldExpression><![CDATA["RECIBIDO POR"]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement style="negrita" stretchType="RelativeToTallestObject" x="286" y="135" width="256" height="60" isPrintWhenDetailOverflows="true" uuid="0149c34f-38f3-48e9-9ba0-566d43653311"/>
				<box leftPadding="2">
					<leftPen lineWidth="1.0"/>
					<bottomPen lineWidth="1.0"/>
					<rightPen lineWidth="1.0"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Bottom"/>
			</textField>
			<staticText>
				<reportElement style="negrita" x="461" y="78" width="80" height="14" uuid="6b2ad5cb-3238-4ae3-8bee-afe08b00c9ed"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8" isBold="false"/>
				</textElement>
				<text><![CDATA[TOTAL]]></text>
			</staticText>
			<staticText>
				<reportElement style="negrita" x="381" y="78" width="80" height="14" uuid="39a1a086-9c25-43ee-b6c3-9760971428ba"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8" isBold="false"/>
				</textElement>
				<text><![CDATA[CERTIFICACION]]></text>
			</staticText>
			<staticText>
				<reportElement style="negrita" x="301" y="78" width="80" height="14" uuid="3f212593-604e-4540-816f-3b2130ba2e21"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8" isBold="false"/>
				</textElement>
				<text><![CDATA[INSCRIPCION]]></text>
			</staticText>
			<textField pattern="¤ #,##0.00">
				<reportElement x="301" y="92" width="80" height="17" isPrintWhenDetailOverflows="true" uuid="25b34112-a0b1-409a-9eec-ea4f80efc03f"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{ins_total}]]></textFieldExpression>
			</textField>
			<textField pattern="¤ #,##0.00">
				<reportElement x="381" y="92" width="80" height="17" isPrintWhenDetailOverflows="true" uuid="d2e497db-d0de-4a77-b441-0c7249c5d9ce"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{cert_total}]]></textFieldExpression>
			</textField>
			<textField pattern="¤ #,##0.00" isBlankWhenNull="false">
				<reportElement x="461" y="92" width="80" height="17" isPrintWhenDetailOverflows="true" uuid="ad43d69e-29cc-413f-a4b9-3df8f33d9f00"/>
				<box>
					<topPen lineWidth="0.5"/>
					<leftPen lineWidth="0.5"/>
					<bottomPen lineWidth="0.5"/>
					<rightPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{total_global_neto}]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
